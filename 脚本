-- æ‰‹æœºæ¨ªå±ç«¯ç½—å¸ƒä¹æ€å¤šåŠŸèƒ½è„šæœ¬
-- ä¸“ä¸ºç§»åŠ¨è®¾å¤‡æ¨ªå±æ¨¡å¼ä¼˜åŒ–

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local GuiService = game:GetService("GuiService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- æ£€æµ‹è®¾å¤‡ç±»å‹
local isMobile = UserInputService.TouchEnabled
local isGamepad = UserInputService.GamepadEnabled

print("è®¾å¤‡æ£€æµ‹: ç§»åŠ¨è®¾å¤‡=" .. tostring(isMobile) .. ", æ‰‹æŸ„=" .. tostring(isGamepad))

-- æ¨ªå±æ¨¡å¼æ£€æµ‹
local function isLandscape()
    local viewportSize = workspace.CurrentCamera.ViewportSize
    return viewportSize.X > viewportSize.Y
end

-- ç­‰å¾…è§’è‰²åŠ è½½
local character = player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

-- çŠ¶æ€å˜é‡
local flyEnabled = false
local noclipEnabled = false
-- ç§»é™¤superClimbEnabledå˜é‡ï¼Œå› ä¸ºä¸‡èƒ½çˆ¬å¢™åŠŸèƒ½å·²åˆ é™¤
local speedEnabled = false
local backgroundEnabled = false
local guiVisible = true
local flySpeed = 30 -- æ‰‹æœºç«¯é£è¡Œé€Ÿåº¦è°ƒä½
local walkSpeed = 16
local bodyVelocity, bodyGyro

-- åˆ›å»ºæ‰‹æœºä¼˜åŒ–æ§åˆ¶GUI
local function createMobileGUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "MobileControlGUI"
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.Parent = playerGui

    -- ä¸»æ§åˆ¶é¢æ¿ï¼ˆåº•éƒ¨å·¥å…·æ ï¼‰
    local mainPanel = Instance.new("Frame")
    mainPanel.Name = "MainPanel"
    mainPanel.Size = UDim2.new(1, 0, 0, 80)
    mainPanel.Position = UDim2.new(0, 0, 1, -80)
    mainPanel.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    mainPanel.BackgroundTransparency = 0.2
    mainPanel.BorderSizePixel = 0
    mainPanel.Parent = screenGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = mainPanel

    -- åŠŸèƒ½æŒ‰é’®å®¹å™¨
    local buttonContainer = Instance.new("Frame")
    buttonContainer.Name = "ButtonContainer"
    buttonContainer.Size = UDim2.new(1, -40, 1, -20)
    buttonContainer.Position = UDim2.new(0, 20, 0, 10)
    buttonContainer.BackgroundTransparency = 1
    buttonContainer.Parent = mainPanel

    local uiListLayout = Instance.new("UIListLayout")
    uiListLayout.FillDirection = Enum.FillDirection.Horizontal
    uiListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    uiListLayout.VerticalAlignment = Enum.VerticalAlignment.Center
    uiListLayout.Padding = UDim.new(0, 10)
    uiListLayout.Parent = buttonContainer

    -- åˆ›å»ºåŠŸèƒ½æŒ‰é’®å‡½æ•°
    local function createMobileButton(name, icon, position)
        local button = Instance.new("TextButton")
        button.Name = name
        button.Size = UDim2.new(0, 60, 0, 60)
        button.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
        button.TextColor3 = Color3.fromRGB(255, 255, 255)
        button.Text = icon .. "\n" .. name
        button.TextSize = 12
        button.Font = Enum.Font.GothamBold
        button.TextWrapped = true
        button.Parent = buttonContainer

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 8)
        corner.Parent = button

        return button
    end

    -- åˆ›å»ºç§»åŠ¨ç«¯åŠŸèƒ½æŒ‰é’®
    local buttons = {
        flyButton = createMobileButton("é£è¡Œ", "ğŸš€", 1),
        noclipButton = createMobileButton("ç©¿å¢™", "ğŸ‘»", 2),
        speedButton = createMobileButton("åŠ é€Ÿ", "âš¡", 3),
        backgroundButton = createMobileButton("èƒŒæ™¯", "ğŸ¨", 4),
        hideButton = createMobileButton("éšè—", "ğŸ‘", 5)
    }

    -- è™šæ‹Ÿæ‘‡æ†ï¼ˆç§»åŠ¨æ§åˆ¶ï¼‰
    local virtualJoystick = Instance.new("Frame")
    virtualJoystick.Name = "VirtualJoystick"
    virtualJoystick.Size = UDim2.new(0, 120, 0, 120)
    virtualJoystick.Position = UDim2.new(0, 30, 1, -150)
    virtualJoystick.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    virtualJoystick.BackgroundTransparency = 0.3
    virtualJoystick.BorderSizePixel = 0
    virtualJoystick.Visible = isMobile
    virtualJoystick.Parent = screenGui

    local joystickCorner = Instance.new("UICorner")
    joystickCorner.CornerRadius = UDim.new(1, 0)
    joystickCorner.Parent = virtualJoystick

    local joystickThumb = Instance.new("Frame")
    joystickThumb.Name = "Thumb"
    joystickThumb.Size = UDim2.new(0, 40, 0, 40)
    joystickThumb.Position = UDim2.new(0.5, -20, 0.5, -20)
    joystickThumb.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    joystickThumb.BackgroundTransparency = 0.2
    joystickThumb.BorderSizePixel = 0
    joystickThumb.Parent = virtualJoystick

    local thumbCorner = Instance.new("UICorner")
    thumbCorner.CornerRadius = UDim.new(1, 0)
    thumbCorner.Parent = joystickThumb

    -- çŠ¶æ€æŒ‡ç¤ºå™¨
    local statusPanel = Instance.new("Frame")
    statusPanel.Name = "StatusPanel"
    statusPanel.Size = UDim2.new(0, 200, 0, 100)
    statusPanel.Position = UDim2.new(1, -210, 0, 10)
    statusPanel.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    statusPanel.BackgroundTransparency = 0.2
    statusPanel.BorderSizePixel = 0
    statusPanel.Parent = screenGui

    local statusCorner = Instance.new("UICorner")
    statusCorner.CornerRadius = UDim.new(0, 8)
    statusCorner.Parent = statusPanel

    local statusLabel = Instance.new("TextLabel")
    statusLabel.Name = "StatusText"
    statusLabel.Size = UDim2.new(1, -10, 1, -10)
    statusLabel.Position = UDim2.new(0, 5, 0, 5)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Text = "å°±ç»ª"
    statusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    statusLabel.TextSize = 14
    statusLabel.TextWrapped = true
    statusLabel.Font = Enum.Font.Gotham
    statusLabel.Parent = statusPanel

    return screenGui, buttons, virtualJoystick, statusLabel
end

-- ç§»åŠ¨ç«¯ä¼˜åŒ–çš„é£è¡ŒåŠŸèƒ½
local function enableMobileFlight()
    if not flyEnabled then
        if bodyVelocity then bodyVelocity:Destroy() end
        if bodyGyro then bodyGyro:Destroy() end

        bodyVelocity = Instance.new("BodyVelocity")
        bodyGyro = Instance.new("BodyGyro")

        bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        bodyVelocity.MaxForce = Vector3.new(3000, 3000, 3000)  -- æ‰‹æœºç«¯åŠ›é‡è°ƒå°
        bodyGyro.MaxTorque = Vector3.new(3000, 3000, 3000)
        bodyGyro.P = 800  -- æ‰‹æœºç«¯çµæ•åº¦è°ƒä½

        pcall(function()
            bodyVelocity.Parent = rootPart
            bodyGyro.Parent = rootPart
        end)

        flyEnabled = true
    end
end

local function disableMobileFlight()
    flyEnabled = false
    if bodyVelocity then bodyVelocity:Destroy() end
    if bodyGyro then bodyGyro:Destroy() end
end

-- ç§»åŠ¨ç«¯ç©¿å¢™åŠŸèƒ½
local function enableMobileNoclip()
    noclipEnabled = true
end

local function disableMobileNoclip()
    noclipEnabled = false
end

-- ç§»åŠ¨ç«¯åŠ é€ŸåŠŸèƒ½ï¼ˆé€Ÿåº¦é€‚ä¸­ï¼‰
local function enableMobileSpeedBoost()
    if humanoid then
        humanoid.WalkSpeed = walkSpeed * 2  -- æ‰‹æœºç«¯2å€é€Ÿåº¦ï¼Œæ›´æ˜“æ§åˆ¶
        speedEnabled = true
    end
end

local function disableMobileSpeedBoost()
    if humanoid then
        humanoid.WalkSpeed = walkSpeed
        speedEnabled = false
    end
end

-- æ ¹æ®æˆªå›¾é£æ ¼ä¼˜åŒ–çš„èƒŒæ™¯æ•ˆæœ
local function enableMobileBackground()
    if not backgroundEnabled then
        local lighting = game:GetService("Lighting")
        
        -- ä¿å­˜åŸå§‹è®¾ç½®
        if not lighting:FindFirstChild("OriginalSettings") then
            local original = Instance.new("Folder")
            original.Name = "OriginalSettings"
            
            local amb = Instance.new("Color3Value")
            amb.Name = "Ambient"
            amb.Value = lighting.Ambient
            amb.Parent = original
            
            local bright = Instance.new("NumberValue")
            bright.Name = "Brightness"
            bright.Value = lighting.Brightness
            bright.Parent = original
            
            original.Parent = lighting
        end

        -- åº”ç”¨ç°è‰²è°ƒèƒŒæ™¯ï¼ˆåŒ¹é…æˆªå›¾é£æ ¼ï¼‰
        lighting.Ambient = Color3.fromRGB(100, 100, 100)
        lighting.Brightness = 0.7
        lighting.ShadowSoftness = 0.2
        
        backgroundEnabled = true
    end
end

local function disableMobileBackground()
    if backgroundEnabled then
        local lighting = game:GetService("Lighting")
        local original = lighting:FindFirstChild("OriginalSettings")
        
        if original then
            lighting.Ambient = original.Ambient.Value
            lighting.Brightness = original.Brightness.Value
        end
        
        backgroundEnabled = false
    end
end

-- è™šæ‹Ÿæ‘‡æ†æ§åˆ¶
local function setupVirtualJoystick(joystick)
    local thumb = joystick:FindFirstChild("Thumb")
    if not thumb then return end

    local isDragging = false
    local dragStart = Vector2.new(0, 0)
    local thumbStart = Vector2.new(0, 0)
    local maxDistance = 40

    -- è§¦æ‘¸å¼€å§‹
    joystick.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch then
            isDragging = true
            dragStart = Vector2.new(input.Position.X, input.Position.Y)
            thumbStart = Vector2.new(thumb.Position.X.Offset, thumb.Position.Y.Offset)
        end
    end)

    -- è§¦æ‘¸ç§»åŠ¨
    joystick.InputChanged:Connect(function(input)
        if isDragging and input.UserInputType == Enum.UserInputType.Touch then
            local currentPos = Vector2.new(input.Position.X, input.Position.Y)
            local delta = currentPos - dragStart
            local distance = delta.Magnitude
            
            if distance > maxDistance then
                delta = delta.Unit * maxDistance
            end
            
            thumb.Position = UDim2.new(0, thumbStart.X + delta.X, 0, thumbStart.Y + delta.Y)
            
            -- æ§åˆ¶è§’è‰²ç§»åŠ¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
            if humanoid and not flyEnabled then
                local moveDirection = Vector3.new(delta.X / maxDistance, 0, -delta.Y / maxDistance)
                humanoid:Move(moveDirection)
            end
        end
    end)

    -- è§¦æ‘¸ç»“æŸ
    joystick.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch then
            isDragging = false
            -- å¹³æ»‘è¿”å›ä¸­å¿ƒ
            local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            local tween = TweenService:Create(thumb, tweenInfo, {Position = UDim2.new(0.5, -20, 0.5, -20)})
            tween:Play()
        end
    end)
end

-- ä¸»åˆå§‹åŒ–å‡½æ•°
local function initializeMobileScript()
    -- ç­‰å¾…æ¨ªå±æ¨¡å¼
    while not isLandscape() do
        RunService.Heartbeat:Wait()
        print("ç­‰å¾…æ¨ªå±æ¨¡å¼...")
    end

    print("æ¨ªå±æ¨¡å¼æ£€æµ‹åˆ°ï¼Œåˆå§‹åŒ–ç§»åŠ¨ç«¯è„šæœ¬...")

    -- åˆ›å»ºç§»åŠ¨ç«¯GUI
    local mobileGUI, buttons, joystick, statusLabel = createMobileGUI()

    -- è®¾ç½®è™šæ‹Ÿæ‘‡æ†
    if isMobile then
        setupVirtualJoystick(joystick)
    end

    -- æŒ‰é’®åŠŸèƒ½ç»‘å®š
    buttons.flyButton.MouseButton1Click:Connect(function()
        flyEnabled = not flyEnabled
        if flyEnabled then
            enableMobileFlight()
            buttons.flyButton.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
            statusLabel.Text = "é£è¡Œæ¨¡å¼å·²æ¿€æ´»\nä½¿ç”¨æ‘‡æ†æ§åˆ¶æ–¹å‘"
        else
            disableMobileFlight()
            buttons.flyButton.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
            statusLabel.Text = "é£è¡Œæ¨¡å¼å·²å…³é—­"
        end
    end)

    buttons.noclipButton.MouseButton1Click:Connect(function()
        noclipEnabled = not noclipEnabled
        if noclipEnabled then
            enableMobileNoclip()
            buttons.noclipButton.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
            statusLabel.Text = "ç©¿å¢™æ¨¡å¼å·²æ¿€æ´»"
        else
            disableMobileNoclip()
            buttons.noclipButton.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
            statusLabel.Text = "ç©¿å¢™æ¨¡å¼å·²å…³é—­"
        end
    end)

    buttons.speedButton.MouseButton1Click:Connect(function()
        speedEnabled = not speedEnabled
        if speedEnabled then
            enableMobileSpeedBoost()
            buttons.speedButton.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
            statusLabel.Text = "åŠ é€Ÿæ¨¡å¼å·²æ¿€æ´»"
        else
            disableMobileSpeedBoost()
            buttons.speedButton.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
            statusLabel.Text = "åŠ é€Ÿæ¨¡å¼å·²å…³é—­"
        end
    end)

    buttons.backgroundButton.MouseButton1Click:Connect(function()
        backgroundEnabled = not backgroundEnabled
        if backgroundEnabled then
            enableMobileBackground()
            buttons.backgroundButton.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
            statusLabel.Text = "èƒŒæ™¯ç‰¹æ•ˆå·²æ¿€æ´»"
        else
            disableMobileBackground()
            buttons.backgroundButton.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
            statusLabel.Text = "èƒŒæ™¯ç‰¹æ•ˆå·²å…³é—­"
        end
    end)

    buttons.hideButton.MouseButton1Click:Connect(function()
        guiVisible = not guiVisible
        mobileGUI.Enabled = guiVisible
        statusLabel.Text = guiVisible and "ç•Œé¢å·²æ˜¾ç¤º" or "ç•Œé¢å·²éšè—"
    end)

    -- ä¸»å¾ªç¯
    local connection
    connection = RunService.Stepped:Connect(function()
        -- é£è¡Œæ§åˆ¶
        if flyEnabled and bodyVelocity and bodyGyro then
            bodyGyro.CFrame = workspace.CurrentCamera.CFrame
            
            -- æ‰‹æœºç«¯ç®€åŒ–çš„é£è¡Œæ§åˆ¶
            local direction = Vector3.new(0, 0, 0)
            
            -- è¿™é‡Œå¯ä»¥æ·»åŠ æ‰‹æœºç‰¹å®šçš„é£è¡Œæ§åˆ¶é€»è¾‘
            -- ä¾‹å¦‚ä½¿ç”¨è®¾å¤‡é™€èºä»ªæˆ–è§¦æ‘¸æ‰‹åŠ¿
            
            local velocity = workspace.CurrentCamera.CFrame:VectorToWorldSpace(direction) * flySpeed
            bodyVelocity.Velocity = velocity
        end

        -- ç©¿å¢™çŠ¶æ€ç»´æŒ
        if noclipEnabled and character then
            for _, child in ipairs(character:GetDescendants()) do
                if child:IsA("BasePart") then
                    child.CanCollide = false
                end
            end
        end

        -- å±å¹•æ–¹å‘æ£€æµ‹
        if not isLandscape() then
            statusLabel.Text = "è¯·åˆ‡æ¢åˆ°æ¨ªå±æ¨¡å¼\nä»¥è·å¾—æœ€ä½³ä½“éªŒ"
        end
    end)

    statusLabel.Text = "ç§»åŠ¨ç«¯è„šæœ¬å·²åŠ è½½\nä¸“ä¸ºæ¨ªå±ä¼˜åŒ–"

    -- è§’è‰²é‡ç½®å¤„ç†
    player.CharacterAdded:Connect(function(newCharacter)
        character = newCharacter
        humanoid = newCharacter:WaitForChild("Humanoid")
        rootPart = newCharacter:WaitForChild("HumanoidRootPart")
        
        -- é‡ç½®çŠ¶æ€
        flyEnabled = false
        noclipEnabled = false
        speedEnabled = false
        
        statusLabel.Text = "è§’è‰²å·²é‡ç½®\nåŠŸèƒ½å·²æ¢å¤é»˜è®¤"
    end)
end

-- å¯åŠ¨ç§»åŠ¨ç«¯è„šæœ¬
if isMobile then
    initializeMobileScript()
else
    print("æ£€æµ‹åˆ°éç§»åŠ¨è®¾å¤‡ï¼Œå»ºè®®ä½¿ç”¨PCç‰ˆè„šæœ¬")
end
